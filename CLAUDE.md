# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Language / 语言约束

**必须使用中文与用户对话。** 专业术语（如 component、props、state、hook、API 等）可以保留英文原文。代码、命令、文件名等技术内容使用英文。

## Project Overview

Skill Deck is a Tauri v2 desktop application for managing AI coding assistant skills (compatible with vercel-labs/skills format). It provides a native GUI companion to the `skills` CLI — no Node.js runtime required.

- **Frontend**: React 19 + TypeScript + Vite, styled with Tailwind CSS v4 + shadcn/ui (Radix UI primitives)
- **Backend**: Rust (Tauri v2), with full skill management logic (install, remove, update, agent detection)
- **Type bridge**: tauri-specta auto-generates `src/bindings.ts` from Rust types

## Commands

```bash
# Development
pnpm dev              # Vite dev server only (port 15673)
pnpm tauri dev        # Full Tauri app with hot reload

# Build (patch-bindings runs automatically before tsc)
pnpm build            # patch-bindings → tsc → vite build
pnpm tauri build      # Production Tauri app → src-tauri/target/release/bundle/

# Lint
pnpm lint             # ESLint (flat config, TS + React rules)

# Utilities
pnpm patch-bindings   # Fix tauri-specta generated bindings for strict TS
```

```bash
# Test
pnpm test             # Vitest run (all tests)
pnpm test:watch       # Vitest watch mode
```

## Architecture

### Frontend → Backend Data Flow

```
React Component
  → src/hooks/useTauriApi.ts    (unwraps Result<T, AppError>, re-exports types)
    → src/bindings.ts           (auto-generated by tauri-specta, DO NOT edit)
      → @tauri-apps/api/core invoke()
        → Rust commands (src-tauri/src/commands/*.rs)
```

The `useTauriApi.ts` layer wraps every tauri-specta command with an `unwrap()` helper that converts `Result<T, E>` into `T | throw E`, keeping components clean of result-matching logic.

### Frontend (src/)

- **Entry**: `main.tsx` → i18n init → `App.tsx` (BrowserRouter + TooltipProvider + Toaster)
- **Routing**: React Router v7 — `/` (SkillsPage), `/settings` (SettingsPage)
- **State**: Zustand stores in `stores/`:
  - `context.ts` — selected context (global vs project path), project list management. Calls backend directly.
  - `skills.ts` — skills data, CRUD operations, dialog state. Reads context via `useContextStore.getState()` (cross-store access pattern).
  - `settings.ts` — theme/locale (persisted to localStorage via `partialize`), default agents (persisted to backend `~/.agents/.skill-lock.json`).
- **i18n**: i18next — locale files in `src/i18n/locales/` (en, zh-CN). All user-facing text must use `t()`.
- **Styling**: Tailwind CSS v4 via Vite plugin; `@/` path alias maps to `src/`

### Backend (src-tauri/src/)

- **commands/**: Tauri command handlers (agents, skills, config, install, remove, update, overwrites)
- **core/**: Business logic — `agents.rs` (detection), `installer.rs`, `uninstaller.rs`, `discovery.rs` (fetch available skills), `source_parser.rs` (9 source formats), `git.rs`, `github_api.rs`, `skill_lock.rs`, `paths.rs`
- **models/**: Data types — `config.rs`, `install.rs`, `source.rs`
- **error.rs**: `AppError` enum with 17 variants (io, yaml, json, git*, path*, install*, etc.)

### Type System

- `src/bindings.ts` is auto-generated by tauri-specta from Rust types — **never edit manually**
- `scripts/patch-bindings.mjs` fixes TS strict-mode issues in generated code (runs in `pnpm build`)
- Key types: `InstalledSkill`, `AgentInfo`, `AgentType` (38+ agent variants), `AppError`, `InstallParams`, `Scope`

### Component Patterns

- UI primitives in `components/ui/` (shadcn/ui, auto-generated)
- Feature components in `components/skills/` with barrel exports via `index.ts`
- Multi-step wizard: `components/skills/add-skill/` (SourceStep → SkillsStep → OptionsStep → ConfirmStep → InstallingStep → CompleteStep/ErrorStep)
- Pages in `pages/` use `useTranslation()` for all user-facing text

## UI 组件约束 (MANDATORY)

**必须优先使用 shadcn/ui 组件，禁止手写已有功能的 UI 组件。**

### 添加组件命令
```bash
npx shadcn@latest add <component-name>
```

### 常用组件对照表
| 需求 | shadcn 组件 | 禁止手写 |
|------|-------------|----------|
| 按钮 | `Button` | ✅ 已安装 |
| 复选框 | `Checkbox` | 手写 checkbox 样式 |
| 卡片容器 | `Card` | div + border + rounded |
| 下拉菜单 | `DropdownMenu` | 手写 menu/popover |
| 选择器 | `Select` | 手写 select dropdown |
| 开关切换 | `Switch` | 手写 toggle |
| 切换按钮 | `Toggle` / `ToggleGroup` | 手写 toggle chips |
| 分隔线 | `Separator` | `<hr>` 或 border-t |
| 输入框 | `Input` | 手写 input 样式 |
| 对话框 | `Dialog` | 手写 modal |
| 提示框 | `Tooltip` | 手写 tooltip |
| 标签页 | `Tabs` | 手写 tab navigation |
| 徽章 | `Badge` | 手写 badge/chip |

### 开发流程
1. **实现 UI 前**：先查阅 shadcn/ui 文档确认是否有现成组件
2. **没有安装**：使用 `npx shadcn@latest add` 添加
3. **确实没有**：才可以在 `components/ui/` 下自定义
4. **查阅文档**：可使用 MCP context7 工具查询 `/shadcn-ui/ui`

## Key Business Rules

### Skill Install Wizard (6-step flow)

```
SourceStep → SkillsStep → OptionsStep → ConfirmStep → InstallingStep → CompleteStep/ErrorStep
```

- **SourceStep**: 用户输入 skill 来源，后端 `source_parser.rs` 解析 9 种格式（git URL、GitHub shorthand `owner/repo`、local path 等）
- **SkillsStep**: 一个 source 可能包含多个 skill（monorepo），调用 `fetchAvailable()` 获取列表，用户选择要安装哪些
- **OptionsStep**: 选择安装到哪些 agents。auto-detect 系统中已安装的 agents（38+ 种），默认选中上次的选择（持久化在 `~/.agents/.skill-lock.json`）
- **ConfirmStep**: 展示最终确认摘要，按 agent 分组显示将安装的 skills。调用 `checkOverwrites()` 检测是否有同名 skill 已存在
- **InstallingStep**: 调用 `installSkills()` 执行安装，支持 overwrite 已存在的 skill
- **CompleteStep/ErrorStep**: 展示安装结果

### Smart Delete (two-mode design)

- **单个 skill 删除**: 调用 `getSkillAgentDetails()` 获取该 skill 安装在哪些 agents 上，用户逐个勾选要从哪些 agent 移除。支持 `fullRemoval`（完全删除）和部分移除（只从选中的 agents 移除 symlink）
- **批量删除**: 展示所有选中 skills 的 agent 分布，统一操作
- **Universal agent 分组**: 分组逻辑 MUST 与 install wizard 的 ConfirmStep 一致（见 commit fd597f6）。Universal agents 作为独立分组展示

### Context System (global vs project scope)

- **Global scope (`'global'`)**: 管理 `~/.agents/` 下的 skills，所有 agents 共享
- **Project scope (路径字符串)**: 管理项目本地 `.agents/` 下的 skills
- 切换 context 时 MUST 调用 `fetchSkills()` 重新加载——skills store 通过 `useContextStore.getState().selectedContext` 读取当前 scope
- 删除当前选中的 project 时，自动回退到 'global'

## Change Dependencies (MANDATORY)

修改代码时，MUST 检查以下联动关系：

- **Rust command 签名变更** → 运行 `pnpm tauri dev` 重新生成 bindings.ts → `pnpm patch-bindings` 修复 TS 严格模式问题 → 检查 `src/hooks/useTauriApi.ts` wrapper 是否需要更新
- **新增/修改 store action** → 检查跨 store 引用：`context.ts` ↔ `skills.ts`（skills 读 context 的 getState()）、`settings.ts`（独立持久化）
- **新增用户可见文本** → MUST 同时添加 `src/i18n/locales/en.json` 和 `src/i18n/locales/zh-CN.json`，禁止硬编码字符串
- **修改功能行为** → MUST 同步更新 CLAUDE.md 中对应的 Key Business Rules 段落
- **新增 UI 组件** → MUST 先查 shadcn/ui 是否有现成组件（见 UI 组件约束表）

## Verification (MANDATORY — run before claiming any task complete)

```bash
# Frontend 检查
pnpm lint && pnpm build

# 测试
pnpm test

# Rust 检查
cd src-tauri && cargo check

# 完整验证
pnpm test && pnpm lint && pnpm build
```

## Agent Development Workflow

### 接到新功能需求时
1. 读取 CLAUDE.md 理解架构和业务规则
2. 读取 `docs/plans/` 中相关的已有 design/impl 文档（如有）
3. 与用户讨论需求，产出 design 文档 → `docs/plans/YYYY-MM-DD-<topic>-design.md`
4. 制定实施计划 → `docs/plans/YYYY-MM-DD-<topic>-impl.md`
5. 按计划逐步实现，每完成一步运行验证命令
6. 全部完成后运行 `pnpm test && pnpm lint && pnpm build`

### 修改已有功能时
1. 读取 CLAUDE.md 中对应的 Key Business Rules 段落
2. 读取相关的 design 文档（如有）
3. 修改代码 + 更新/新增测试
4. 检查 Change Dependencies 联动规则
5. 如果功能行为发生变化，同步更新 CLAUDE.md 中的 Business Rules
